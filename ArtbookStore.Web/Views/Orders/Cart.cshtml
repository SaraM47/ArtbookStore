@model ArtbookStore.Web.Models.Order

@{
    // Page title used by the layout
    ViewData["Title"] = "Your Cart";
}

<section class="sf-cart">

    <h1 class="sf-cart-title">Your Cart</h1>

    <!-- Empty cart message is used if there is no order, or no items, show an "empty cart" message.
    -->
    @if (Model == null || Model.OrderItems == null || !Model.OrderItems.Any())
    {
        <div class="sf-cart-empty">
            <p>Your cart is empty.</p>

            <!-- Link back to product listing -->
            <a asp-controller="Products"
               asp-action="Index"
               class="sf-btn">
                Browse Products
            </a>
        </div>
    }
    else
    {
        <div class="sf-cart-items">

            <!-- Loop through each order item -->
            @foreach (var item in Model.OrderItems)
            {
                <div class="sf-cart-row">

                    <!-- Product image column -->
                    <div class="sf-cart-image">
                        @if (!string.IsNullOrEmpty(item.Product?.ImageUrl))
                        {
                            <img src="@item.Product.ImageUrl" alt="@item.Product?.Title" />
                        }
                    </div>

                    <!-- Product title and unit price for one item -->
                    <div class="sf-cart-title-col">
                        <h3>@item.Product?.Title</h3>
                        <p class="sf-cart-price">
                            @item.UnitPrice.ToString("F2")
                        </p>
                    </div>

                    <!-- Quantity update form is for Posts to OrdersController.UpdateQuantity. Includes AntiForgery token and hidden input for orderItemId. -->
            <div class="sf-cart-qty">
                <form asp-action="UpdateQuantity" method="post" class="sf-cart-qty-form">
                    @Html.AntiForgeryToken()

                    <!-- Identify which cart item should be updated -->
                    <input type="hidden" name="orderItemId" value="@item.Id" />

                    <!-- Quantity controls (minus, input, plus) -->
                    <div class="sf-cart-qty-control">

                        <!-- Minus button updates the input via JavaScript -->
                        <button type="button"
                                class="sf-qty-btn"
                                onclick="changeCartQty(this, -1)">
                            <i class="bi bi-dash"></i>
                        </button>

                        <!-- Quantity input sent to the server -->
                        <input type="number"
                            name="quantity"
                            value="@item.Quantity"
                            min="1"
                            class="sf-qty-input"
                            aria-label="Quantity" />

                        <!-- Plus button updates the input via JavaScript -->
                        <button type="button"
                                class="sf-qty-btn"
                                onclick="changeCartQty(this, 1)">
                            <i class="bi bi-plus"></i>
                        </button>

                    </div>

                    <!-- Submit button sends the updated quantity to server -->
                    <button type="submit" class="sf-qty-update">
                        Update
                    </button>
                </form>
            </div>
                    <!-- Line total for quantity * unit price -->
                    <div class="sf-cart-line-total">
                        @((item.Quantity * item.UnitPrice).ToString("F2"))
                    </div>

                    <!-- Remove item form for Posts to OrdersController.RemoveItem -->
                    <div class="sf-cart-remove">
                        <form asp-action="RemoveItem" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="orderItemId" value="@item.Id" />

                            <button type="submit" class="sf-remove-btn">
                                Remove
                            </button>
                        </form>
                    </div>

                </div>
            }

        </div>

        <!-- Divider line between items and summary -->
        <div class="sf-cart-divider"></div>

        <!-- Cart summary with total amount and action buttons -->
        <div class="sf-cart-summary">

            <!-- Total for entire cart (calculated server-side) -->
            <h2>Total: @Model.TotalAmount.ToString("F2")</h2>

            <div class="sf-cart-actions">
                <a asp-controller="Products"
                   asp-action="Index"
                   class="sf-btn">
                    Continue Shopping
                </a>

                <a asp-action="Checkout"
                   class="sf-btn">
                    Checkout
                </a>
            </div>
        </div>
    }

</section>

@section Scripts {
<script>
/*
* Updates the quantity input in the cart UI (client-side only). The actual update happens after the user clicks the "Update" button, which submits the form to the server.
*/
function changeCartQty(button, amount) {

    const form = button.closest("form");
    const input = form.querySelector("input[name='quantity']");

    let value = parseInt(input.value);
    value += amount;

    if (value < 1) value = 1;

    input.value = value;
}
</script>
}